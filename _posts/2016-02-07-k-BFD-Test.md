---
title:	BGP with BFD on EVE-NG with CSR1000v
sidebar_toc:	true
---

## BGP with BFD on EVE-NG with CSR1000v

BFD (Bi-Directional Forwarding Detection) is a superfast protocol to detect link failures withing milliseconds or microseconds!

Routing protocols have mechanism to detect link failures as well with `HELLO` like mechanism but is not good enough for convergence where technologies like VOIP is involved. We can tune the routing protocol for exmaple OSPF to use a dead interval of one second. (Which for VOIP is too high)


> BFD runs independent of the routing protocol.

Once BFD is UP you can use other routing protocols to leverage is for fast convergence.

> BFD is not up until you use the same in a protocol.

Once BFD stops receiving packets from the peer , it notifies the protocol using it about the same. (Which is faster than the protocols native dead timer expiry)

### BFD had two modes of operation
- `Asynchronous Mode` : The Asynchronous mode is like the Hello and Holddown timer , when BFD does not receive some of them the session is teared.
- `Demand Mode` : In this once BFD has found a neighbour it wont continuously send packets to neighbour but uses only a polling mechanism. For example noticing the rx/tx of the interface. As of now neither Cisco nor any other vendor supports this mode.

Both modes support `echo` mode , in which a device sends a echo packet and other device reponds withour processing it. If the sender does not get the response the neighborship is teared.

BFD is basically a keepalive system whic utilizes UDP and CEF.
Orginally BFD was designed for directly connected peers.

BFD can utilize two type of packets:
1. ECHO (Echo Packets came later , these are not received by CPU)
2. CONTROL (Processed by CPU)

> ECHO mode is on by default.
> ECHO packets are encapuslated un UDP .

Echo packets go between the interfaces , the loss of the Echo packet triggers the notification to the upper level process.

Echo packets are not processed by the CPU but Control packets are .

So how does BFD do the ECHO without involving the CPU ?

ECHO Packet consists of the `senders` IP and MAC in both source and destination!
To elaborate it , the BFD echo packets sent by X will have X's MAC and IP in Source and Destination!

Now when the packet is sent to the directly connected device (which has CEF enabled) look at the destination and forwards it to it without being processed by the CPU !

You can turn off echo mode (Generallt you would not) .

So if you rely on Control Packet , you basically are taxing CPU.


<img src="/assets/bfd.png" alt="" style="width: 800px;"/>

Intial BFD is configured on the interface :

`bfd interval 100 min_rx 200 multiplier 3`

First Value : I would like to transmit BFD echo packets every 100msec.
Second Value : The fastest I can process incoming BFD ECHO packets is every 200msec. Dont send any faster than that .

### From Cisco Documentation
`[no] bfd interval <50-999> min_rx <1-999> multiplier <3-50>`
- `interval`: Determines how frequently (in milliseconds) BFD packets will be sent to BFD peers.
- `min_rx`: Determines how frequently (in milliseconds) BFD packets will be expected to be received from BFD peers
- `multiplier`: The number of consecutive BFD packets which must be missed from a BFD peer before declaring that peer unavailable, and informing the higher-layer protocols of the failure.



| R1 | R2
| ------  | ------ |
| `bfd interval 100 min_rx 200 multiplier 3`| `bfd interval 300 min_rx 75 multiplier 4` |

1. In the above example `R1` send the min_rx as 200 , `R2` see that and says "I was planing to send it every 300ms but since you can process faster , I will send faster (i.e every 200ms)" .

And becuase it has a multiplier of `4` , If it does not receive it within 4x200 (800ms) it will tear the relationship.

2. In the above example `R2` sends the min_rx  as 75 , `R1` see that and says "I was planing to send it every 100ms but since you can process faster , I will send faster (i.e every 75ms)" .

And becuase it has a multiplier of `3` , If it does not receive it within 3x75 ms it will tear the relationship.

> So basically your min_rx is the speed your neighbor send the packets to you .



```sh
CSR3#show running-config int gi1
Building configuration...

Current configuration : 141 bytes
!
interface GigabitEthernet1
 ip address 192.168.12.1 255.255.255.0
 bfd interval 50 min_rx 50 multiplier 3
end

CSR3#show running-config | sec bgp
router bgp 1
 timers bgp 10 11 10
 neighbor 192.168.12.2 remote-as 2
 neighbor 192.168.12.2 fall-over bfd
```

```sh
CSR4#show running-config int gi1
Building configuration...

Current configuration : 131 bytes
!
interface GigabitEthernet1
 ip address 192.168.12.2 255.255.255.0
 negotiation auto
 bfd interval 50 min_rx 50 multiplier 3
end

CSR4#show running-config | sec bgp
router bgp 2
 timers bgp 10 11 10
 neighbor 192.168.12.1 remote-as 1
 neighbor 192.168.12.1 fall-over bfd

CSR4(config-router)#
*Mar 30 21:19:31.028: %BFD-6-BFD_SESS_CREATED: BFD-SYSLOG: bfd_session_created, neigh 192.168.12.1 proc:BGP, idb:GigabitEthernet1 handle:1 act
*Mar 30 21:19:31.147: %BFDFSM-6-BFD_SESS_UP: BFD-SYSLOG: BFD session ld:4097 handle:1 is going UP
*Mar 30 21:19:41.187: %SYS-5-CONFIG_I: Configured from console by console
*Mar 30 21:19:46.680: %BFDFSM-6-BFD_SESS_DOWN: BFD-SYSLOG: BFD session ld:4097 handle:1,is going Down Reason: ECHO FAILURE
*Mar 30 21:19:46.682: %BGP-5-NBR_RESET: Neighbor 192.168.12.1 reset (BFD adjacency down)
*Mar 30 21:19:46.682: %BGP-5-ADJCHANGE: neighbor 192.168.12.1 Down BFD adjacency down
*Mar 30 21:19:46.682: %BGP_SESSION-5-ADJCHANGE: neighbor 192.168.12.1 IPv4 Unicast topology base removed from session  BFD adjacency down
*Mar 30 21:19:46.683: %BFD-6-BFD_SESS_DESTROYED: BFD-SYSLOG: bfd_session_destroyed,  ld:4097 neigh proc:BGP, handle:1 act

```



> For example if you have configured the BFD timers as 100msecs  with multiplier as 3 so that BFD session will go down if the device did not get response within 300 msecs
For the Voice network we need to have less 200 ms delay in the network otherwise the voice communication will break. Please consult with your ISP while setting up BFD with them.


``` highlight
---
type: image
featimg: 3.jpg
author: someone
title: image post
description: describing the post
tags: [tag1, tag2, tag3]
category: [category]
---
```

### Gallery

A gallery does require a bit more work. The thing we do here is similar to a WordPress shortcode.

We define images and titles within the front-matter and do an include in the end.

So in the front-matter you would do something like this:

``` highlight
---
type: gallery
featimg: gallery-5.jpg
title: Gallery
tags: [gallery, image]
category: [image]
gallery:
    - images:
      - filename: gallery-1.jpg
        alttext: Bloom Flat
      - filename: gallery-2.jpg
        alttext: Bloom
      - filename: gallery-3.jpg
        alttext: Blossom in a Star
      - filename: gallery-4.jpg
        alttext: Blossom
      - filename: gallery-5.jpg
        alttext: Bubbly Bloom
      - filename: gallery-6.jpg
        alttext: Rays of Gold
      - filename: gallery-7.jpg
        alttext: Exotic
      - filename: gallery-8.jpg
        alttext: Filled out
---
```

There are two different options how to include the gallery. The first is a scroll-through, that places all of the images at full-width within the content. The second creates a box with thumbnails, which reveals a lightbox when clicked on and can be navigated by touch, arrow-keys or plain old mouse commands.

In the content section you will need to integrate one of the includes:

**Scroll-Through:**

``` highlight
{% include gallery.html %}
```

**Lightbox:**

``` highlight
{% include gallery_lightbox.html %}
```

### Vimeo

Creating a Vimeo video post is quite simple.

It is one of the three post types, that allows for the iFrame to be on the index pages. If you decide to go with the Vimeo post type, you won’t need to include a featured image, as it will not be displayed anywhere.

The type has to be Vimeo and then just include the embed code as well as the featured image `homedisplay: iframe`

``` highlight
---
type: vimeo
vimeo-embed: <iframe src="//player.vimeo.com/video/118589137" width="500" height="281" frameborder="0" webkitallowfullscreen mozallowfullscreen allowfullscreen></iframe>
homedisplay: iframe
author: someone
title: Vimeo
description: describing the post
tags: [tag1, tag2, tag3]
category: [category]
---
```

### YouTube

YouTube is a little bit different from Vimeo. Since the URL structure is always the same you don’t need to add the entire embed code.

Find the video ID of your video (the part of the URL after `/watch?v=VIDEOID`) and put that in the front matter.

also use homedisplay to display the iFrame, otherwise set the featured image as you do it with the other post types.

``` highlight
---
type: youtube
yt-video-id: e0RFirBWQsE
author: someone
title: YouTube
description: describing the post
tags: [tag1, tag2, tag3]
category: [category]
---
```

### Audio

An audio post is technically the same as a Vimeo post. You just place the iframe embed code in the front matter.

The front matter follows the same rules:

``` highlight
---
type: audio
audio-embed: <iframe width=100% height="450" scrolling="no" frameborder="no" src="https://w.soundcloud.com/player/?url=https%3A//api.soundcloud.com/tracks/188464611&amp;auto_play=false&amp;hide_related=false&amp;show_comments=true&amp;show_user=true&amp;show_reposts=false&amp;visual=true"></iframe>
homedisplay: iframe
author: someone
title: Audio
description: describing the post
tags: [tag1, tag2, tag3]
category: [category]
---
```

## Navigation

After your pages are set, you might as well just go ahead and work on your navigation.

The menu is a responsive off-canvas menu. It offers a two-level dropdown menu. Since the parent elements work as triggers, you will not be able to link them, so make sure your parent element’s `href` is pointing to a hashtag.

Otherwise it’s just your basic list.

Keep the toggle-links for the functionality to work.

The navigation is located in `_includes/nav.html`

We went with the static navigation, but feel free to create a dynamic one. There are tutorials out there that go over the steps. Just type the question into the search engine of your choice.

# Additional Functionality

Jekyll is fantastic, but it comes with a few restrictions.

First and probably biggest bummer of all is the lack of a comment function.

But it’s not that bad, because there are possibilities to include comments. One of the most popular comment systems, is actually just embedded through HTML and that’s the one we will use. We’re looking at you Disqus.

The other thing is a search function. If you don’t feel the need of integrating a search function that users actually utilize, just leave it out. If you think a search function is a necessity, there are different options you can use.

## Comment Form

The comment system that’s most popular is [disqus](https://disqus.com/).

You need to create an account and register your site.

Then access the universal code and create a new include.

Then include it in the layouts you want to use it with.

IT’s that simple.

## Search function

When it comes to search functions, there are several different options and opinions. Some people don’t like certain search functions, others love them, etc.

We did include a dummy search form, jut for design purposes in case you want to include a search function.

There are possibilities floating around on the internet using javascript. Another option would be to create a Google custom search.

We don’t set any rules or recommendations. It is totally up to you what you want to use.

Also, the world of inter webs provides much better instructions on that matter than we could ever write. So please Google it.

# Deployment

When you are ready to go live, you have to think about a few things.

We’re gonna touch upon some of them, help you with your decision and assist you with the step into the public.

## GitHub or Server?

[GitHub pages](https://pages.github.com/) is free and it runs jekyll. Perfect. But of course you might not want to choose GitHub to host your site on.

A reason for that might be, that you own a server or don’t mind paying. Or you just don’t want your page to be open sourced.

But GitHub has a downside as well. It runs jekyll in save-mode. This means no plugins. We do use plugins in Gridster for category pages, tag pages and author pages. If you don’t want to use that, GitHub might work as a CMS for you. We did include support for [prose.io](http://prose.io), which kinda turns it all into a pretty CMS, that looks definitely better than Blogger or WordPress.

If you want to use plugins, you still can host your site on GitHub but you will need to compile the site manually. It actually would take even more steps than just regenerating, quite a few git commands are involved. But grunt is here to save the day and you can still enjoy free hosting. It just needs a bit more time and is a littlebit less flexible.

But if you are like us and never leave the house without your laptop anyway, you’re just as flexible as can be.

If you choose the server you will just need to compile your site and host the `_site` folder like you would do it with any other HTML site.

If you decide to go with GitHub hosting, read on.

## Plugins: Yes or No?

It is a decision, an endless back and forth. Or maybe not?

If you want to have several people contributing on the site with plugins you will have to act as a moderator. So people can create posts on GitHub, but in order for the blog posts to go live, you will have to pull the changes, rebuild the site with grunt and push the live site back up with grunt deploy. If that is not a step you want to take, you might just sacrifice the plugins (no author pages, no category pages, no tag pages) and have new posts going live automatically.

There are a lot of pros and cons for every method, and the decision is personal. Even if you go without the plugins, the site will still have a lot of nice features. And the archive will still work.

After you’ve made a decision, you are ready to deploy.

If you decided to go with the plugins, skip the next section. If you go without plugins, skip the section after the next one.

## Deploy on GitHub Without Plugins

Deployment without plugins is actually really easy.

Grab the URL you will be hosting your site on as well as the subfolder. If you are going to host your site on GitHub, set the two variables `url` and `baseurl` in the `_config.yml` file.

Put all of the files not listed below (especially the `node_modules` and `_site` folders) to your `.gitignore`, because you definitely won’t need those up there. If you don’t use plugins you just want to push the following files to GitHub (file in brackets means these might have changed or you might not need them)

``` highlight
├── _data/
│   └── galleries.yml
│
├── _includes
│   ├── article_index.html
│   ├── ( article_index_short.html ) // you might not need it, with no plugins
│   ├── footer.html
│   ├── ( full.html )
│   ├── gallery.html
│   ├── gallery_lightbox.html
│   ├── head.html
│   ├── header.html
│   ├── ( icon.html )
│   ├── ( logo.html )
│   ├── monthly_archive.html
│   ├── nav.html
│   ├── sidebar.html
│   ├── ( svg.html )
│   └── yearly_archive.html
│
├── _layouts
│   ├── index.html
│   ├── ( index_alt.html ) // again, you only need it for the short index
│   ├── page.html
│   ├── page_full.html
│   ├── post.html
│   └── post_full.html
│
├── _posts
│   └── // all your posts
│
├── css
│   ├── classic.css
│   ├── grid.css
│   └── main.css
│
├── fonts
│   └── // all of the font files
│
├── img
│   └── // all your images
│
├── js
│   └── build/
│       └── global.min.js
│
├── _config.yml
│
├── feed.xml
│
├── index.html
│
├── pagename // symbolically for all your static pages
│   └── index.md
│
├── .gitignore
└── ( README.md )
```

When that is done, GitHub will run jekyll and serve the resulting site under the URL.

If you want to publish a new post, just create a new one in the `_posts` directory and push. Or just log into GitHub and write it directly on there.

This will work for new content

If you want to change something in your design though (new js stuff, new stylesheets, everything grunt does for you) you will have to pull it all down and run grunt again, to compile sass, run autoprefixer and uglify and merge all of the script files.

## Deploy with Plugins

If you want to deploy with plugins, you will need to follow a few steps.

The basic idea is to push the built `_site` folder with all of your other source files and then copy that site onto the main branch that GitHub will serve. So in case you use the user-repository: username.github.io, you want to create a branch called source and push all of the things there. The site will then be copied into the master branch.

For every other repository, a branch called `gh-pages` is required.

If the site will be located within a subfolder, make sure to add baseurl and url (set url in any case) for the site in the `_config.yml` file.

Now for deployment.

You might not want to push your `node_modules` folder, because it takes a lot of space and is not relevant, even if people want to check out the source.

But make sure that *under no circumstances*, your `_site` folder ends up on your `.gitignore` file, because you need to build it yourself, as the jekyll GitHub runs, would end up being a save build, so no plugins.

The git commands you would need to execute would take quite some time, so we let grunt do the work. But we need to set that up first.

Open your `gruntfile.js` and find the following section:

Put your remote url here and choose to what branch the \_site should be pushed to.

``` highlight
buildcontrol: {
    options: {
        dir: '_site',
        commit: true,
        push: true,
        message: 'Built _site from commit %sourceCommit% on branch %sourceBranch%'
    },
    pages: {
        options: {
            remote: 'https://github.com/user/reponame.git', // change that
            branch: 'gh-pages' // adjust here
        }
    }
}
```

After you did that, build your site, and commit all of your changes to the source branch. After all of your changes are commited, run the grunt command in your terminal.

``` highlight
grunt deploy
```

grunt buildcontrol will do it’s thing. Enter your credentials when you are asked to and then your site should be live.

Yeahy!

{% endraw %}
